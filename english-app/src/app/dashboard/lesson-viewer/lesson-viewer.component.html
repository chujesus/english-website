<div class="container-fluid py-4">
    <div id="topics-content" class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item">
                                <a routerLink="/dashboard/modules" class="text-decoration-none">Modules</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a [routerLink]="['/dashboard/courses']"
                                    [queryParams]="{id: courseId, title: courseTitle, userId: user.id}"
                                    class="text-decoration-none">{{
                                    courseTitle }}</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">{{ topic?.title }}</li>
                        </ol>
                    </nav>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-book-reader me-2"></i>
                        {{ topic?.title }}
                    </h2>
                    <p class="text-muted mb-0">{{ topic?.objective }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading lesson content...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
        <button class="btn btn-outline-danger btn-sm ms-2" (click)="loadLessons()">
            Try Again
        </button>
    </div>

    <!-- Lesson Content -->
    <div *ngIf="!loading && !error && currentLesson" class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 sidebar">
            <div class="card lesson-navigation-card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white border-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <h6 class="mb-0 fw-semibold">
                            <i class="fas fa-map-marked-alt me-2"></i>
                            Lesson Navigation
                        </h6>
                        <span class="badge bg-white text-primary px-2 py-1 rounded-pill">
                            {{ lessons.length }} sections
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="navigation-list">
                        <a *ngFor="let section of lessons; let i = index" (click)="openSection(section.id!)"
                            class="navigation-item d-flex align-items-center p-3 text-decoration-none"
                            [class.active]="section.id === activeSection">

                            <!-- Section Number -->
                            <div class="section-number me-3">
                                <span class="number">{{ i + 1 }}</span>
                            </div>

                            <!-- Section Content -->
                            <div class="section-content flex-grow-1">
                                <div class="section-title">{{ section.title }}</div>
                                <div class="section-subtitle text-muted" *ngIf="section.objective">
                                    {{ section.objective.length > 50 ? (section.objective | slice:0:50) + '...' :
                                    section.objective }}
                                </div>
                            </div>

                            <!-- Status Icon -->
                            <div class="section-status ms-2">
                                <i class="fas fa-play-circle text-primary" *ngIf="section.id === activeSection"></i>
                                <i class="fas fa-circle text-muted opacity-50" *ngIf="section.id !== activeSection"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Progress Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Your Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar" [class]="getProgressBarClass(getTopicOverallProgress())"
                            [style.width.%]="getTopicOverallProgress()" role="progressbar">
                        </div>
                    </div>
                    <small class="text-muted">{{ getTopicOverallProgress() }}% Complete</small>

                    <div class="mt-3">
                        <!-- Show complete topic progress -->
                        <div class="small text-muted mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Reading:</span>
                                <span [class]="topicProgress.reading > 0 ? 'text-success' : 'text-muted'">
                                    {{ topicProgress.reading > 0 ? '✓ ' + topicProgress.reading + '%' : '✓ 0%' }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Speaking:</span>
                                <span [class]="topicProgress.speaking > 0 ? 'text-success' : 'text-muted'">
                                    {{ topicProgress.speaking > 0 ? '✓ ' + topicProgress.speaking + '%' : '✓ 0%' }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Listening:</span>
                                <span [class]="topicProgress.listening > 0 ? 'text-success' : 'text-muted'">
                                    {{ topicProgress.listening > 0 ? '✓ ' + topicProgress.listening + '%' : '✓ 0%' }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Writing:</span>
                                <span [class]="topicProgress.writing > 0 ? 'text-success' : 'text-muted'">
                                    {{ topicProgress.writing > 0 ? '✓ ' + topicProgress.writing + '%' : '✓ 0%' }}
                                </span>
                            </div>
                        </div>
                        <!-- Topic completed message -->
                        <div class="alert alert-success alert-sm mb-0" *ngIf="getTopicOverallProgress() >= 100">
                            <i class="fas fa-check-circle me-1"></i>Topic Completed!
                        </div>
                        <!-- Incomplete progress message -->
                        <div class="alert alert-warning alert-sm mb-0"
                            *ngIf="getTopicOverallProgress() < 100 && getTopicOverallProgress() > 0">
                            <i class="fas fa-clock me-1"></i>Keep practicing! Complete all lessons to finish this topic.
                        </div>
                        <!-- Start message -->
                        <div class="alert alert-info alert-sm mb-0" *ngIf="getTopicOverallProgress() === 0">
                            <i class="fas fa-play-circle me-1"></i>Start your learning journey! Select a lesson to
                            begin.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="lesson-content" class="col-lg-9">
            <div class="lesson-content" [style.height.px]="height > screenHeight ? height : screenHeight">
                <!-- Keywords Section -->
                <div class="card mb-4" *ngIf="topic!.keywords?.length">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-tags me-2"></i>
                            Key Vocabulary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6" *ngFor="let keyword of topic!.keywords">
                                <span class="badge bg-primary me-2 mb-2">{{ keyword }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lesson Content Section (Rich Text Content) -->
                <div class="card mb-4" *ngIf="currentLesson[0]?.content && currentLesson[0]?.content.trim()">
                    <div class="card-header bg-gradient-info text-white border-0">
                        <div class="d-flex align-items-center">
                            <div class="icon-container me-3">
                                <i class="fas fa-file-alt fa-lg"></i>
                            </div>
                            <div>
                                <h5 class="mb-0 fw-semibold">
                                    <i class="fas fa-book-open me-2"></i>
                                    Lesson Content
                                </h5>
                                <small class="opacity-75">Additional information and context for this lesson</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body lesson-rich-content">
                        <div class="content-wrapper p-3 bg-light rounded border-start border-info border-4">
                            <div class="rich-text-content" [innerHTML]="safeLessonContent"></div>
                        </div>
                        <div class="content-footer mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                This content provides additional context and enriches your understanding of the topic.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Sections -->
                <div *ngFor="let section of currentLesson; let i = index" [id]="'section-' + i"
                    class="section-content mb-4">

                    <!-- Vocabulary Section -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-book me-2"></i>
                                {{ section.title }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">{{ section.objective }}</p>
                            <div class="row" *ngIf="section.speaking?.length">
                                <div class="col-md-6" *ngFor="let word of section.speaking">
                                    <div class="vocabulary-item mb-3 p-3 border rounded">
                                        <h6 class="text-primary">{{ word.english }}</h6>
                                        <p class="text-muted mb-1"><em>{{ word.spanish }}</em></p>
                                        <p class="mb-2">{{ word.definition }}</p>
                                        <small class="text-success">Example: {{ word.example }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grammar Section -->
                    <div class="card mt-3" *ngIf="section.is_grammar">
                        @for (item of section.grammar; track $index) {
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-language me-2"></i>
                                {{ item.title }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="grammar-rule mb-3 p-3 border-start border-warning border-4 bg-light">
                                <h6 class="text-warning mb-2">Grammar Rule:</h6>
                                <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.6;">{{ item.rule }}</p>
                            </div>
                            <div *ngIf="item.examples" class="grammar-examples">
                                <h6>Examples:</h6>
                                <div class="row">
                                    <div *ngFor="let example of item.examples"
                                        class="col-md-6 mb-2 d-flex align-items-start">
                                        <i class="fas fa-arrow-right text-success me-2"></i>
                                        <span>{{ example }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        }
                    </div>

                    <!-- Reading Section -->
                    <div class="card mt-3" *ngIf="!loadingPractices && section.is_reading">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-book-open me-2"></i>
                                {{ section.reading.title }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="reading-text mb-3 p-3 border-start border-success border-4 bg-light">
                                <h6 class="text-success mb-2">Paragraph:</h6>
                                <p class="text-dark mb-0" style="font-size: 1rem; line-height: 1.6;">{{
                                    section.reading.text }}</p>
                            </div>
                            <div class="reading-content">
                                <div class="row">
                                    <div class="col-md-6" *ngFor="let item of section.reading.questions; let i = index">
                                        <div class="mb-4 p-3 border rounded">
                                            <p class="fw-semibold">{{ i + 1 }}. {{ item.question }}</p>

                                            <div *ngFor="let opt of item.options" class="form-check ms-3">
                                                <input id="q{{ i }}_opt{{ opt }}" class="form-check-input" type="radio"
                                                    [name]="'q' + i" [value]="opt" [(ngModel)]="userAnswers[i]" />
                                                <label class="form-check-label" for="q{{ i }}_opt{{ opt }}">
                                                    {{ opt }}
                                                </label>
                                            </div>

                                            <div *ngIf="feedback[i]" class="mt-2">
                                                <span [ngClass]="{
                                                    'text-success fw-bold': feedback[i] === 'correct',
                                                    'text-danger fw-bold': feedback[i] === 'wrong'
                                                    }">
                                                    {{ feedback[i] === 'correct'
                                                    ? 'Correct!'
                                                    : 'Wrong! The correct answer is: ' + item.answer }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2 mt-3">
                                        <!-- <button class="btn btn-secondary" (click)="reset()">Reset</button> -->
                                        <button class="btn"
                                            [class]="savedStates.reading.saved ? 'btn-success' : 'btn-primary'"
                                            (click)="saveReading(section.reading.questions)"
                                            [disabled]="!allAnswered(section.reading.questions)">
                                            <i class="fas"
                                                [class]="savedStates.reading.saved ? 'fa-check me-1' : 'fa-save me-1'"></i>
                                            {{ savedStates.reading.saved ? 'Saved' : 'Save Reading Practice' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Section -->
                    <div class="card mt-3" *ngIf="!loadingPractices && section.is_speaking">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-microphone me-2"></i>
                                Speaking Practice
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="practice-section">
                                <app-speech-practice [targetSentences]="speechPracticeItems"
                                    [savedPracticeItems]="savedStates.speaking.practiceItems"
                                    [isCompleted]="savedStates.speaking.saved"
                                    [savedRecognizedTexts]="speakingRecognizedTexts"
                                    [savedCorrectness]="speakingCorrectness"
                                    (practiceUpdate)="onSpeakingPracticeUpdate($event)">
                                </app-speech-practice>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button class="btn" [class]="savedStates.speaking.saved ? 'btn-success' : 'btn-primary'"
                                    (click)="saveSpeaking(speechPracticeItems)"
                                    [disabled]="!isSpeakingPracticeComplete()"
                                    [title]="isSpeakingPracticeComplete() ? '' : 'Complete all speaking exercises first'">
                                    <i class="fas"
                                        [class]="savedStates.speaking.saved ? 'fa-check me-1' : 'fa-save me-1'"></i>
                                    {{ savedStates.speaking.saved ? 'Saved' : 'Save Speaking Practice' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Listening Section -->
                    <div class="card mt-3" *ngIf="!loadingPractices && section.is_listening">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-headphones me-2"></i>
                                Listening Practice
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="practice-section">
                                <app-speech-quiz [listening]="listening" [savedAnswers]="savedStates.listening.answers"
                                    [savedFeedback]="savedStates.listening.feedback"
                                    [isCompleted]="savedStates.listening.saved"
                                    (answerSelected)="onListeningAnswerSelected($event)">
                                </app-speech-quiz>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <!-- <button class="btn btn-secondary" (click)="reset()">Reset</button> -->
                                <button class="btn"
                                    [class]="savedStates.listening.saved ? 'btn-success' : 'btn-primary'"
                                    (click)="saveListening(listening)" [disabled]="!allListeningAnswered(listening)">
                                    <i class="fas"
                                        [class]="savedStates.listening.saved ? 'fa-check me-1' : 'fa-save me-1'"></i>
                                    {{ savedStates.listening.saved ? 'Saved' : 'Save Listening Practice' }}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Writing Section -->
                    <div class="card mt-3" *ngIf="!loadingPractices && section.is_writing">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-pencil-alt me-2"></i>
                                Writing Practice
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="practice-section">
                                <app-fill-in-blank-practice [questions]="questions"
                                    [savedAnswers]="savedStates.writing.answers"
                                    [isWritingCompleted]="savedStates.writing.saved">
                                </app-fill-in-blank-practice>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <!-- <button class="btn btn-secondary" (click)="reset()">Reset</button> -->
                                <button class="btn" [class]="savedStates.writing.saved ? 'btn-success' : 'btn-primary'"
                                    (click)="saveWriting(questions)" [disabled]="!isWritingPracticeComplete()"
                                    [title]="isWritingPracticeComplete() ? '' : 'Complete all writing exercises first'">
                                    <i class="fas"
                                        [class]="savedStates.writing.saved ? 'fa-check me-1' : 'fa-save me-1'"></i>
                                    {{ savedStates.writing.saved ? 'Saved' : 'Save Writing Practice' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>