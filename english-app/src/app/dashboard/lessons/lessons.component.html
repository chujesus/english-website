<div class="p-5 bg-body-tertiary rounded-3" *ngIf="selectedLesson && !loading">
    <div class="container-fluid row">
        <div class="col-12 p-5 text-bg-dark rounded-3">
            <h2 class="mb-4">üß© {{ selectedLesson.title }}</h2>
            <p class="lead">{{ selectedLesson.objective }}</p>

            <section class="mb-4">
                <h4>üéØ Objective</h4>
                <p>{{ selectedLesson.objective }}</p>
            </section>

            <section *ngIf="selectedLesson.keywords && selectedLesson.keywords.length > 0">
                <h4>üîë Keywords</h4>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-secondary" *ngFor="let keyword of selectedLesson.keywords">{{ keyword
                        }}</span>
                </div>
            </section>

            <section *ngIf="selectedLesson.examples && selectedLesson.examples.length > 0" class="mt-3">
                <h4>üí° Examples</h4>
                <ul>
                    <li *ngFor="let example of selectedLesson.examples">{{ example }}</li>
                </ul>
            </section>
        </div>
    </div>
</div>

<div class="container my-4" *ngIf="selectedLesson">
    <!-- Loading indicator -->
    <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading lesson content...</p>
    </div>

    <!-- Error message -->
    <div *ngIf="!loading && error" class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Error</h4>
        <p>{{ error }}</p>
        <button class="btn btn-outline-danger" (click)="goBack()">Go Back</button>
    </div>

    <!-- Lesson content -->
    <div *ngIf="!loading && !error">
        <div class="mb-4">
            <h2 class="text-primary">{{ selectedLesson.title }}</h2>
            <p class="lead">{{ selectedLesson.objective }}</p>
            <div class="mb-3">
                <span class="badge bg-info me-2">{{ selectedLesson.cefrLevel }}</span>
                <span class="badge bg-secondary me-1" *ngFor="let keyword of selectedLesson.keywords">{{ keyword
                    }}</span>
            </div>
        </div>

        <!-- Stepper nav -->
        <ul class="nav nav-pills mb-4 justify-content-center stepper">
            <li class="nav-item" *ngFor="let section of selectedLesson.sections; let i = index">
                <button class="nav-link" [class.active]="i === currentStep" (click)="goToStep(i)">
                    {{ i + 1 }}. {{ section.title }}
                </button>
            </li>
        </ul>

        <!-- Step content -->
        <div *ngIf="selectedLesson.sections[currentStep]" class="card shadow-sm">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-secondary">
                        {{ selectedLesson.sections[currentStep].title }}
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-secondary"
                            *ngIf="selectedLesson.sections[currentStep].type === 'speaking'"
                            (click)="openSpeechPractice(selectedLesson.sections[currentStep])">
                            üé§ Speaking practice
                        </button>
                        <button class="btn btn-secondary"
                            *ngIf="selectedLesson.sections[currentStep].type === 'listening'"
                            (click)="openSpeechQuizPractice(selectedLesson.sections[currentStep])">
                            üéß Listening practice
                        </button>
                        <button class="btn btn-secondary"
                            *ngIf="selectedLesson.sections[currentStep].type === 'practice'"
                            (click)="openFillInBlankPractice(selectedLesson.sections[currentStep])">
                            üìù Fill in blank practice
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Content display based on section type -->
                <div *ngIf="selectedLesson.sections[currentStep].type === 'vocabulary' || 
                           selectedLesson.sections[currentStep].type === 'grammar'" class="table-responsive">
                    <table class="table table-striped table-bordered m-0">
                        <thead class="table-light">
                            <tr class="text-center">
                                <th>English</th>
                                <th>Spanish</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of selectedLesson.sections[currentStep].content">
                                <td>{{ item.english || item.phrase || item.word || '' }}</td>
                                <td>{{ item.spanish || item.translation || item.meaning || '' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Text content for reading/listening sections -->
                <div *ngIf="selectedLesson.sections[currentStep].type === 'reading' || 
                           selectedLesson.sections[currentStep].type === 'listening'" class="p-4">
                    <div *ngFor="let item of selectedLesson.sections[currentStep].content" class="mb-3">
                        <p>{{ item.text || item.content || item }}</p>
                    </div>
                </div>

                <!-- Practice content -->
                <div *ngIf="selectedLesson.sections[currentStep].type === 'practice'" class="p-4">
                    <p class="text-muted">Click the practice button above to start exercises.</p>
                </div>
            </div>
        </div>

        <!-- Navigation buttons -->
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" (click)="goToPreviousLesson()" [disabled]="lessonIndex === 0">
                ‚Üê Previous Lesson
            </button>
            <button class="btn btn-outline-primary" (click)="goBack()">
                Back to Course
            </button>
            <button class="btn btn-outline-secondary" (click)="goToNextLesson()">
                Next Lesson ‚Üí
            </button>
        </div>
    </div>
</div>

<div #speechModal class="modal fade" id="speechModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-4 fw-bold text-center w-100 text-primary">üó£Ô∏è Speaking Practice</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- <app-speech-practice [targetSentences]="speechPracticeItems"></app-speech-practice> -->
            </div>
        </div>
    </div>
</div>

<div #fillInBlank class="modal fade" id="fillInBlank" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-4 fw-bold text-center w-100 text-primary">Fill In Blank</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <app-fill-in-blank-practice [questions]="questions"></app-fill-in-blank-practice>
            </div>
        </div>
    </div>
</div>

<div #speechQuiz class="modal fade" id="speechQuiz" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-4 fw-bold text-center w-100 text-primary">Listen and Choose the Word</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <app-speech-quiz [listening]="listening"></app-speech-quiz>
            </div>
        </div>
    </div>
</div>