<div class="container-fluid py-4">
    <!-- Enhanced Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <!-- Breadcrumb Navigation -->
                            <nav aria-label="breadcrumb" class="mb-2">
                                <ol class="breadcrumb mb-0 bg-transparent p-0">
                                    <li class="breadcrumb-item">
                                        <a routerLink="/dashboard/control-panel"
                                            class="text-primary cursor-pointer fw-semibold">
                                            <i class="fas fa-home me-1"></i>Dashboard
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active" aria-current="page">
                                        User Management
                                    </li>
                                </ol>
                            </nav>

                            <!-- Dynamic Page Title -->
                            <h2 class="mb-0 d-flex align-items-center">
                                <i [class]="getCurrentIcon()" class="me-2"></i>
                                {{ getCurrentTitle() }}
                                <span class="badge bg-secondary ms-2 rounded-pill">{{ getCurrentCount() }}</span>
                            </h2>
                            <p class="mb-0 mt-1">{{ getCurrentDescription() }}</p>
                        </div>
                        <button class="btn btn-outline-primary" routerLink="/dashboard/control-panel">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Alert -->
    <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
        <button type="button" class="btn-close" (click)="error = ''" aria-label="Close"></button>
    </div>

    <!-- Success Alert -->
    <div *ngIf="success" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ success }}
        <button type="button" class="btn-close" (click)="success = ''" aria-label="Close"></button>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>Search & Filters
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Search Input -->
                        <div class="col-md-4">
                            <label for="searchTerm" class="form-label">Search Users</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchTerm" [(ngModel)]="searchTerm"
                                    (input)="onSearchChange()" placeholder="Search by name, email, or ID...">
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <div class="col-md-4">
                            <label for="filterByStatus" class="form-label">Filter by Status</label>
                            <select class="form-select" id="filterByStatus" [(ngModel)]="filterByStatus"
                                (change)="onFilterChange()">
                                <option value="all">All Status</option>
                                <option value="active">Active Only</option>
                                <option value="inactive">Inactive Only</option>
                            </select>
                        </div>

                        <!-- Profile Filter -->
                        <div class="col-md-4">
                            <label for="filterByProfile" class="form-label">Filter by Role</label>
                            <select class="form-select" id="filterByProfile" [(ngModel)]="filterByProfile"
                                (change)="onFilterChange()">
                                <option value="all">All Roles</option>
                                <option value="administrator">Administrators</option>
                                <option value="student">Students</option>
                            </select>
                        </div>
                    </div>

                    <!-- Results Summary -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    Showing {{ getPaginatedUsers().length }} of {{ filteredUsers.length }} users
                                    ({{ users.length }} total)
                                </small>
                                <button class="btn btn-outline-secondary btn-sm" (click)="loadUsers()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading users...</p>
    </div>

    <!-- Users Table -->
    <div *ngIf="!loading" class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Registered Users
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>User Info</th>
                                    <th>Contact</th>
                                    <th>Role</th>
                                    <th>Starting Module</th>
                                    <th>Status</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let user of getPaginatedUsers(); trackBy: trackByUserId">
                                    <!-- User Info -->
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-3">
                                                <img *ngIf="user.url_image" [src]="user.url_image"
                                                    class="avatar-img rounded-circle" [alt]="user.name">
                                                <div *ngIf="!user.url_image"
                                                    class="avatar-placeholder rounded-circle bg-primary text-white d-flex align-items-center justify-content-center">
                                                    {{ user.name!.charAt(0).toUpperCase() }}
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ user.name }}</div>
                                                <small class="text-muted">ID: {{ user.identification }}</small>
                                                <div *ngIf="user.first_name || user.last_name" class="small text-muted">
                                                    {{ user.first_name }} {{ user.last_name }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Contact -->
                                    <td>
                                        <div class="small">
                                            <i class="fas fa-envelope me-1 text-muted"></i>
                                            {{ user.email }}
                                        </div>
                                        <div *ngIf="user.phone" class="small text-muted">
                                            <i class="fas fa-phone me-1"></i>
                                            {{ user.phone }}
                                        </div>
                                    </td>

                                    <!-- Role -->
                                    <td>
                                        <span class="badge"
                                            [class]="user.profile === 1 ? 'bg-warning text-dark' : 'bg-info'">
                                            {{ getUserRoleName(user.profile!) }}
                                        </span>
                                    </td>

                                    <!-- Starting Module -->
                                    <td class="text-center starting-module-column">
                                        <!-- Students (profile = 1) -->
                                        <div *ngIf="user.profile === 1">
                                            <span *ngIf="user.starting_module" class="badge fs-6"
                                                [class]="getStartingModuleBadgeClass(user.starting_module)">
                                                {{ user.starting_module }}
                                            </span>
                                            <span *ngIf="!user.starting_module" class="text-muted small">
                                                -
                                            </span>
                                        </div>

                                        <!-- Administrators (profile = 0) -->
                                        <div *ngIf="user.profile === 0" class="text-muted small">
                                            <i class="fas fa-star"></i>
                                        </div>
                                    </td>

                                    <!-- Status -->
                                    <td>
                                        <span [class]="getUserStatusBadge(user.state!).class">
                                            {{ getUserStatusBadge(user.state!).text }}
                                        </span>
                                    </td>

                                    <!-- Registered Date -->
                                    <td>
                                        <small class="text-muted">
                                            {{ user.created_at | date:'short' }}
                                        </small>
                                    </td>

                                    <!-- Actions -->
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Edit Button -->
                                            <button *ngIf="canEditUser(user)" type="button"
                                                class="btn btn-outline-primary btn-sm" (click)="openEditModal(user)"
                                                title="Edit User">
                                                <i class="fas fa-edit"></i>
                                            </button>

                                            <!-- Toggle Status Button -->
                                            <button type="button" class="btn btn-sm"
                                                [class]="user.state === 1 ? 'btn-outline-warning' : 'btn-outline-success'"
                                                (click)="toggleUserStatus(user)"
                                                [title]="user.state === 1 ? 'Deactivate User' : 'Activate User'">
                                                <i
                                                    [class]="user.state === 1 ? 'fas fa-user-slash' : 'fas fa-user-check'"></i>
                                            </button>

                                            <!-- Delete Button -->
                                            <button *ngIf="canDeleteUser(user)" type="button"
                                                class="btn btn-outline-danger btn-sm" (click)="openDeleteModal(user)"
                                                title="Delete User">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- No Users Found -->
                                <tr *ngIf="getPaginatedUsers().length === 0">
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="fas fa-users fa-2x mb-3"></i>
                                        <div>No users found matching your criteria</div>
                                        <small>Try adjusting your search or filters</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div *ngIf="totalPages > 1" class="card-footer">
                    <nav aria-label="Users pagination">
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            <li class="page-item" [class.disabled]="currentPage === 1">
                                <button class="page-link" (click)="goToPage(currentPage - 1)"
                                    [disabled]="currentPage === 1">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            </li>
                            <li *ngFor="let page of getPages()" class="page-item" [class.active]="page === currentPage">
                                <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                            </li>
                            <li class="page-item" [class.disabled]="currentPage === totalPages">
                                <button class="page-link" (click)="goToPage(currentPage + 1)"
                                    [disabled]="currentPage === totalPages">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1"
    role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="fas fa-user-edit me-2"></i>Edit User
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="closeEditModal()"
                    aria-label="Close"></button>
            </div>
            <form [formGroup]="editUserForm" (ngSubmit)="saveUser()">
                <div class="modal-body">
                    <div class="row">
                        <!-- Identification -->
                        <div class="col-md-6 mb-3">
                            <label for="editIdentification" class="form-label">
                                Identification <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control"
                                [class.is-invalid]="isFieldInvalid('identification')" id="editIdentification"
                                formControlName="identification">
                            <div class="invalid-feedback" *ngIf="isFieldInvalid('identification')">
                                {{ getFieldError('identification') }}
                            </div>
                        </div>

                        <!-- Username -->
                        <div class="col-md-6 mb-3">
                            <label for="editName" class="form-label">
                                Username <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" [class.is-invalid]="isFieldInvalid('name')"
                                id="editName" formControlName="name">
                            <div class="invalid-feedback" *ngIf="isFieldInvalid('name')">
                                {{ getFieldError('name') }}
                            </div>
                        </div>

                        <!-- First Name -->
                        <div class="col-md-6 mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" formControlName="first_name">
                        </div>

                        <!-- Last Name -->
                        <div class="col-md-6 mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" formControlName="last_name">
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="editEmail" class="form-label">
                                Email <span class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control" [class.is-invalid]="isFieldInvalid('email')"
                                id="editEmail" formControlName="email">
                            <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
                                {{ getFieldError('email') }}
                            </div>
                        </div>

                        <!-- Phone -->
                        <div class="col-md-6 mb-3">
                            <label for="editPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" [class.is-invalid]="isFieldInvalid('phone')"
                                id="editPhone" formControlName="phone">
                            <div class="invalid-feedback" *ngIf="isFieldInvalid('phone')">
                                {{ getFieldError('phone') }}
                            </div>
                        </div>

                        <!-- Profile -->
                        <div class="col-md-6 mb-3">
                            <label for="editProfile" class="form-label">
                                Role <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" [class.is-invalid]="isFieldInvalid('profile')" id="editProfile"
                                formControlName="profile">
                                <option value="">Select Role</option>
                                <option value="1">Administrator</option>
                                <option value="2">Student</option>
                            </select>
                            <div class="invalid-feedback" *ngIf="isFieldInvalid('profile')">
                                {{ getFieldError('profile') }}
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6 mb-3">
                            <label for="editState" class="form-label">
                                Status <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" [class.is-invalid]="isFieldInvalid('state')" id="editState"
                                formControlName="state">
                                <option value="1">Active</option>
                                <option value="0">Inactive</option>
                            </select>
                            <div class="invalid-feedback" *ngIf="isFieldInvalid('state')">
                                {{ getFieldError('state') }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" [disabled]="editUserForm.invalid || loading">
                        <i class="fas fa-save me-1"></i>
                        <span *ngIf="loading">Saving...</span>
                        <span *ngIf="!loading">Save Changes</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'"
    tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteUserModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="closeDeleteModal()"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-user-times fa-3x text-danger mb-3"></i>
                    <h5>Are you sure you want to delete this user?</h5>
                    <div *ngIf="selectedUser" class="mt-3">
                        <strong>{{ selectedUser.name }}</strong><br>
                        <small class="text-muted">{{ selectedUser.email }}</small>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This action cannot be undone. All user data will be permanently deleted.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="loading">
                    <i class="fas fa-trash me-1"></i>
                    <span *ngIf="loading">Deleting...</span>
                    <span *ngIf="!loading">Delete User</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Starting Module Selection Modal -->
<app-starting-module-modal [show]="showStartingModuleModal" [userName]="getSelectedUserName()"
    (modalClose)="closeStartingModuleModal()" (moduleSelected)="onModuleSelected($event)">
</app-starting-module-modal>

<!-- Modal backdrop -->
<div *ngIf="showEditModal || showDeleteModal" class="modal-backdrop fade show"></div>